<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>éš¨æ©Ÿé¤å»³æ‹‰éœ¸</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{--bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; --accent2:#a78bfa; --danger:#ef4444; --ok:#16a34a;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Segoe UI","Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
  .wrap{width:420px; max-width:100%; margin:14px auto; padding:12px}
  .card{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.28)}
  .title{font-weight:800; font-size:18px}
  .muted{color:var(--muted); font-size:12px}
  input,select,button{background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:8px 10px; outline:none}
  input:focus,select:focus{border-color:var(--accent)} button{cursor:pointer; font-weight:700}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .primary{background:linear-gradient(90deg,var(--accent),var(--accent2)); border:none; color:#001018}
  .ghost{background:#141a26} .danger{background:#2a1111; border-color:#7f1d1d} .ok{background:#0f2016; border-color:#14532d}
  .small{font-size:12px}
  .tag{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; background:#0c1320; border:1px solid rgba(255,255,255,.1); border-radius:999px}
  .pill{font-size:11px; padding:2px 6px; border-radius:999px; background:#0a111d; border:1px solid rgba(255,255,255,.08); color:var(--muted)}
  .list{display:grid; grid-template-columns:1fr auto; gap:6px; align-items:center}
  .divider{height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent); margin:10px 0}

  /* æ‰‹æ©Ÿé«˜åº¦è‡ªé©æ‡‰ + æ…£æ€§æ»¾å‹• + ç´°æ²è»¸ */
  .listbox{
    max-height:60svh;
    overflow-y:auto;
    -webkit-overflow-scrolling: touch;
    padding-right:4px;
  }
  .listbox::-webkit-scrollbar { width:6px; }
  .listbox::-webkit-scrollbar-track { background:transparent; }
  .listbox::-webkit-scrollbar-thumb { background-color:rgba(255,255,255,0.3); border-radius:3px; }

  /* æ‹‰éœ¸æ¡† */
  .slotbox{width:100%; max-width:400px; height:60px; margin:10px auto 6px; border-radius:12px; border:2px solid rgba(255,255,255,.12); background:linear-gradient(180deg,#0c1423,#0a0f1a); display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative}
  .slottext{font-size:22px; font-weight:800; white-space:nowrap; text-align:center}
  .slotmask::before, .slotmask::after{content:""; position:absolute; left:0; right:0; height:12px; pointer-events:none}
  .slotmask::before{top:0; background:linear-gradient(180deg,rgba(15,23,42,.85),transparent)}
  .slotmask::after{bottom:0; background:linear-gradient(0deg,rgba(15,23,42,.85),transparent)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">ğŸ° éš¨æ©Ÿé¤å»³æ‹‰éœ¸</div>
      <div class="muted">æ”¯æ´ 5 çµ„è¨˜æ†¶ï¼ˆå„è‡ªæ¸…å–®ï¼‰ã€‚åŒ¯å…¥æ™‚å¯æŒ‡å®šè¦å¥—ç”¨å“ªä¸€çµ„ã€‚</div>
      <div class="divider"></div>

      <!-- è¨˜æ†¶çµ„æ§åˆ¶åˆ— -->
      <div class="row">
        <select id="profileSelect" title="é¸æ“‡è¨˜æ†¶çµ„">
          <option value="0">è¨˜æ†¶ 1</option>
          <option value="1">è¨˜æ†¶ 2</option>
          <option value="2">è¨˜æ†¶ 3</option>
          <option value="3">è¨˜æ†¶ 4</option>
          <option value="4">è¨˜æ†¶ 5</option>
        </select>
        <input id="profileName" placeholder="é€™çµ„çš„åç¨±ï¼Œä¾‹å¦‚ï¼šæ–°åº—å®¶" style="flex:1;min-width:140px">
        <button id="btnRename" class="ok small">æ›´å</button>
        <span class="pill" id="profileHint"></span>
      </div>

      <div class="divider"></div>

      <!-- æ‹‰éœ¸ -->
      <div class="slotbox slotmask"><div id="slotText" class="slottext">â€”</div></div>
      <div class="row">
        <select id="mode"><option value="weighted">åŠ æ¬ŠæŠ½ç±¤</option><option value="pure">ç´”éš¨æ©Ÿ</option></select>
        <input id="exclude" placeholder="æ’é™¤åˆ†é¡ï¼šä¾‹ å°å¼, é€Ÿé£Ÿ" style="flex:1;min-width:120px">
        <button id="btnSpin" class="primary">æ‹‰ä¸€ä¸‹ ğŸ²</button>
        <button id="btnAgain" class="ghost">å†æ‹‰ä¸€æ¬¡</button>
      </div>

      <div class="divider"></div>

      <!-- åŒ¯å…¥ï¼åŒ¯å‡º & æ–°å¢ -->
      <div class="row">
        <button id="btnImport" class="ghost small">åŒ¯å…¥ JSONï¼ˆå¯æŒ‡å®šè¨˜æ†¶ï¼‰</button>
        <button id="btnExport" class="ghost small">åŒ¯å‡ºæ­¤è¨˜æ†¶</button>
        <button id="btnExportAll" class="ghost small">åŒ¯å‡ºå…¨éƒ¨</button>
        <button id="btnClear" class="danger small">æ¸…ç©ºæ­¤è¨˜æ†¶</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="name" placeholder="æ–°å¢ï¼šé¤å»³åç¨±" style="flex:2;min-width:160px">
        <input id="tags" placeholder="åˆ†é¡(é€—è™Ÿ)" style="flex:1;min-width:120px">
        <input id="weight" type="number" min="1" max="10" value="1" style="width:90px">
        <button id="btnAdd" class="primary">ï¼‹æ–°å¢</button>
      </div>

      <div class="divider"></div>

      <!-- æ¸…å–® -->
      <div class="title" style="font-size:16px">æ¸…å–®</div>
      <div class="muted small">ï¼ˆé»åˆ†é¡å¯å¿«é€Ÿå¡«å…¥ã€Œæ’é™¤åˆ†é¡ã€ï¼‰</div>
      <div id="list" class="listbox" style="margin-top:6px"></div>
    </div>
  </div>

<script>
(()=> {
  const storeKey="restaurant-picker-profiles-v1";
  const $=sel=>document.querySelector(sel);

  // ===== ç‹€æ…‹ï¼š5 çµ„è¨˜æ†¶ =====
  const state={
    active:0,
    spinning:false,
    profiles:[
      {name:"è¨˜æ†¶ 1", items:[]},
      {name:"è¨˜æ†¶ 2", items:[]},
      {name:"è¨˜æ†¶ 3", items:[]},
      {name:"è¨˜æ†¶ 4", items:[]},
      {name:"è¨˜æ†¶ 5", items:[]}
    ]
  };

  const defaults=[
    {id:"a1", name:"ç¦éš†éµè·¯ä¾¿ç•¶", tags:["ä¾¿ç•¶"], weight:1, disabled:false},
    {id:"a2", name:"å°å®å™¹Qä¾¿ç•¶", tags:["ä¾¿ç•¶"], weight:1, disabled:false},
    {id:"a3", name:"é‹’å…ƒç‡’è‡˜", tags:["ç‡’è‡˜"], weight:1, disabled:false},
    {id:"a4", name:"è‚¯å¾·åŸº", tags:["é€Ÿé£Ÿ","ç‚¸é›"], weight:1, disabled:false},
  ];

  function cur(){ return state.profiles[state.active]; }

  // ===== å„²å­˜ / è¼‰å…¥ =====
  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
  function load(){
    try{
      const raw=localStorage.getItem(storeKey);
      if(raw){
        const parsed=JSON.parse(raw);
        if(Array.isArray(parsed.profiles) && parsed.profiles.length===5){
          state.profiles=parsed.profiles.map((p,i)=>({
            name: p.name || `è¨˜æ†¶ ${i+1}`,
            items: Array.isArray(p.items) ? p.items : []
          }));
          state.active = Math.min(4, Math.max(0, parsed.active||0));
        }
      }else{
        // é è¨­çµ¦ç¬¬ä¸€çµ„ä¸€äº›è³‡æ–™ï¼Œå…¶ä»–ç©ºç™½
        state.profiles[0].items = defaults;
      }
    }catch(e){
      state.profiles[0].items = defaults;
    }
  }

  const genId=()=>Math.random().toString(36).slice(2,9);
  const uniq=arr=>[...new Set(arr.map(s=>s.trim()).filter(Boolean))];
  const escapeHtml=s=>s.replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

  function buildPool(){
    const mode=$("#mode").value, exclude=uniq($("#exclude").value.split(","));
    let list=cur().items.filter(it=>!it.disabled);
    if(exclude.length){ list=list.filter(it=>!(it.tags||[]).some(t=>exclude.includes(t))); }
    if(list.length===0) return [];
    if(mode==="pure") return list.slice();
    const pool=[]; list.forEach(it=>{ const w=Math.max(1,Math.min(50,it.weight||1)); for(let i=0;i<w;i++) pool.push(it); });
    return pool;
  }

  function renderProfilesUI(){
    $("#profileSelect").value=String(state.active);
    $("#profileName").value=state.profiles[state.active].name||`è¨˜æ†¶ ${state.active+1}`;
    $("#profileHint").textContent = `ç›®å‰ï¼š${state.profiles[state.active].name}`;
  }

  function renderList(){
    const root=$("#list"); root.innerHTML="";
    const items=cur().items;
    if(items.length===0){ root.innerHTML=`<div class="muted">é€™çµ„ç›®å‰æ²’æœ‰é¤å»³ï¼Œè«‹å…ˆåŒ¯å…¥æˆ–æ–°å¢ã€‚</div>`; return; }

    const head=document.createElement("div");
    head.className="list muted small";
    head.innerHTML=`<div>åç¨±</div><div style="text-align:right">æ¬Šé‡ / æ“ä½œ</div>`;
    root.appendChild(head);

    items.forEach(it=>{
      const row=document.createElement("div"); row.className="list";

      const left=document.createElement("div");
      const name=document.createElement("div");
      name.innerHTML=`<strong ${it.disabled?'style="opacity:.5;text-decoration:line-through"':''}>${escapeHtml(it.name)}</strong>`;
      left.appendChild(name);

      const tags=document.createElement("div");
      (it.tags||[]).forEach(t=>{
        const b=document.createElement("button");
        b.className="tag small"; b.textContent=t;
        b.onclick=()=>{const ex=uniq($("#exclude").value.split(",")); if(ex.includes(t)) $("#exclude").value=ex.filter(x=>x!==t).join(", "); else { ex.push(t); $("#exclude").value=ex.join(", "); }};
        left.appendChild(b);
      });

      const right=document.createElement("div"); right.style.textAlign="right";
      const w=document.createElement("span"); w.className="pill"; w.textContent="x"+(it.weight||1);

      const up=document.createElement("button"); up.className="ghost small"; up.textContent="ï¼‹";
      up.title="æ¬Šé‡ +1"; up.onclick=()=>{ it.weight=Math.min(10,(it.weight||1)+1); save(); renderList(); };

      const down=document.createElement("button"); down.className="ghost small"; down.textContent="ï¼";
      down.title="æ¬Šé‡ -1"; down.onclick=()=>{ it.weight=Math.max(1,(it.weight||1)-1); save(); renderList(); };

      const toggle=document.createElement("button"); toggle.className="ghost small"; toggle.textContent=it.disabled?"æ¢å¾©":"æ’é™¤";
      toggle.onclick=()=>{ it.disabled=!it.disabled; save(); renderList(); };

      const del=document.createElement("button"); del.className="danger small"; del.textContent="åˆªé™¤";
      del.onclick=()=>{ cur().items = cur().items.filter(x=>x.id!==it.id); save(); renderList(); };

      right.append(w, up, down, toggle, del);
      row.append(left, right);
      root.appendChild(row);
    });
  }

  // ===== æ‹‰éœ¸ï¼ˆåªæ›´æ–° slotTextï¼‰ =====
  let spinTimer=null;
  function spinOnce(){
    const pool=buildPool();
    const slot=document.getElementById("slotText");
    if(!pool.length){ if(slot) slot.textContent="ï¼ˆæ²’æœ‰å¯æŠ½çš„åº—å®¶ï¼‰"; return; }
    if(state.spinning) return;
    state.spinning=true;

    let step=35, elapsed=0, idx=Math.floor(Math.random()*pool.length);
    const total=1800+Math.random()*900;
    if (slot) slot.textContent="é–‹å§‹ï¼";
    clearInterval(spinTimer);

    try{
      spinTimer=setInterval(()=>{
        elapsed+=step;
        idx=(idx+1+Math.floor(Math.random()*2))%pool.length;
        if (slot) slot.textContent=pool[idx].name;
        step=Math.min(140, step*1.06);
        if (elapsed>=total){
          clearInterval(spinTimer);
          const pick=pool[idx];
          if (slot) slot.textContent=pick.name;
          state.spinning=false;
        }
      }, step);
    }catch(e){
      clearInterval(spinTimer);
      state.spinning=false;
      console.error(e);
    }
  }

  // ===== åŒ¯å…¥ / åŒ¯å‡ºï¼ˆå¯æŒ‡å®šè¨˜æ†¶çµ„ï¼‰ =====
  function exportJson(obj, filename){
    const data=JSON.stringify(obj, null, 2);
    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(data).then(()=>alert(`å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼š${filename}`)).catch(()=>openText(data));
    }else openText(data);
    function openText(text){
      const w=window.open("", "_blank"); if(!w){ alert("è«‹å…è¨±é–‹å•Ÿæ–°è¦–çª—"); return; }
      w.document.write("<pre style='white-space:pre-wrap;padding:12px;background:#0f172a;color:#e5e7eb;'>"+text.replace(/</g,"&lt;")+"</pre>");
      w.document.close();
    }
  }

  function normalizeItems(list){
    return (list||[]).map(x=>({
      id: x.id || genId(),
      name: x.name || "",
      tags: Array.isArray(x.tags) ? x.tags : [],
      weight: x.weight || 1,
      disabled: !!x.disabled
    })).filter(x=>x.name.trim().length>0);
  }

  // ===== ç¶å®šäº‹ä»¶ =====
  document.getElementById("btnSpin").onclick=spinOnce;
  document.getElementById("btnAgain").onclick=spinOnce;

  // è¨˜æ†¶çµ„åˆ‡æ› / æ›´å
  $("#profileSelect").onchange=(e)=>{ state.active=Number(e.target.value||0); save(); renderProfilesUI(); renderList(); };
  $("#btnRename").onclick=()=>{ const v=$("#profileName").value.trim(); if(!v) return; state.profiles[state.active].name=v; save(); renderProfilesUI(); };

  // æ–°å¢ / æ¸…ç©º
  document.getElementById("btnAdd").onclick=()=>{
    const name=$("#name").value.trim(); if(!name) return;
    const tags=uniq($("#tags").value.split(","));
    const weight=Math.max(1,Math.min(10,parseInt($("#weight").value)||1));
    cur().items.push({id:genId(), name, tags, weight, disabled:false});
    $("#name").value=""; $("#tags").value=""; $("#weight").value="1";
    save(); renderList();
  };

  document.getElementById("btnClear").onclick=()=>{
    if(confirm(`ç¢ºå®šæ¸…ç©ºã€Œ${cur().name||"é€™çµ„"}ã€çš„æ¸…å–®ï¼Ÿ`)){
      cur().items=[]; save(); renderList();
      const slot=document.getElementById("slotText"); if (slot) slot.textContent="â€”";
    }
  };

  // åŒ¯å‡ºï¼šç•¶å‰è¨˜æ†¶ / å…¨éƒ¨
  document.getElementById("btnExport").onclick=()=>exportJson({items:cur().items}, `${state.profiles[state.active].name||"profile"}.json`);
  document.getElementById("btnExportAll").onclick=()=>exportJson({active:state.active, profiles:state.profiles}, "all-profiles.json");

  // åŒ¯å…¥ï¼ˆå¯æŒ‡å®šè¦å¥—åˆ°å“ªä¸€çµ„ã€å–ä»£æˆ–åˆä½µï¼‰
  document.getElementById("btnImport").onclick=()=>{
    const input=document.createElement("input");
    input.type="file"; input.accept="application/json";
    input.onchange=(e)=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const json=JSON.parse(reader.result);

          // 1) æ±ºå®šè¦åŒ¯å…¥åˆ°å“ªä¸€çµ„
          const ask = prompt(`è¦åŒ¯å…¥åˆ°ç¬¬å¹¾çµ„è¨˜æ†¶ï¼Ÿ\nè¼¸å…¥ 1~5ï¼›ç•™ç©º=ç›®å‰é€™ä¸€çµ„ï¼ˆ${state.active+1}ï¼š${cur().name||("è¨˜æ†¶ "+(state.active+1))}ï¼‰`);
          let targetIdx = state.active;
          if(ask && /^[1-5]$/.test(ask)) targetIdx = Number(ask)-1;

          // 2) åˆ¤æ–·åŒ¯å…¥å…§å®¹æ ¼å¼
          if(Array.isArray(json.items)){
            // å–®ä¸€æ¸…å–®
            const imported = normalizeItems(json.items);

            // 3) å–ä»£ or åˆä½µ
            const replace = confirm(`è¦ç”¨åŒ¯å…¥è³‡æ–™ã€Œå–ä»£ã€è¨˜æ†¶ ${targetIdx+1}ï¼ˆ${state.profiles[targetIdx].name}ï¼‰å—ï¼Ÿ\næŒ‰ã€Œå–æ¶ˆã€å‰‡æ”¹ç‚ºã€Œåˆä½µã€ã€‚`);
            if(replace){
              state.profiles[targetIdx].items = imported;
            }else{
              // åˆä½µï¼ˆä»¥ name ç‚º key å»é‡ï¼‰
              const existing = state.profiles[targetIdx].items.slice();
              const map = new Map(existing.map(x=>[x.name, x]));
              imported.forEach(x=>{
                if(map.has(x.name)){
                  // è‹¥å·²å­˜åœ¨ï¼Œæ›´æ–° tags/weightï¼ˆå¯ä¾éœ€æ±‚èª¿æ•´ï¼‰
                  const o = map.get(x.name);
                  const tags = Array.from(new Set([...(o.tags||[]), ...(x.tags||[])]));
                  map.set(x.name, {...o, tags, weight: x.weight || o.weight || 1, disabled: !!x.disabled});
                }else{
                  map.set(x.name, x);
                }
              });
              state.profiles[targetIdx].items = Array.from(map.values());
            }

            save(); renderProfilesUI(); if(targetIdx===state.active) renderList();
            const slot=document.getElementById("slotText");
            if (slot) slot.textContent=`å·²åŒ¯å…¥åˆ°ã€Œ${state.profiles[targetIdx].name}ã€`;
          }
          else if (Array.isArray(json.profiles) && json.profiles.length===5){
            // å…¨éƒ¨è¨˜æ†¶ï¼ˆå®Œæ•´å‚™ä»½ï¼‰æ ¼å¼
            const newProfiles = json.profiles.map((p,i)=>({
              name: p.name || `è¨˜æ†¶ ${i+1}`,
              items: normalizeItems(p.items)
            }));
            const replaceAll = confirm("åµæ¸¬åˆ° 5 çµ„å®Œæ•´å‚™ä»½ï¼Œè¦ã€Œå–ä»£ã€ä½ çš„å…¨éƒ¨è¨˜æ†¶å—ï¼Ÿï¼ˆå–æ¶ˆ=åªåŒ¯å…¥åˆ°ç›®å‰é€™ä¸€çµ„ï¼‰");
            if(replaceAll){
              state.profiles = newProfiles;
            }else{
              state.profiles[state.active].items = newProfiles[state.active].items;
            }
            save(); renderProfilesUI(); renderList();
          }
          else{
            alert("JSON æ ¼å¼éŒ¯èª¤ï¼šéœ€ { items:[...] } æˆ– { profiles:[...5çµ„...] }");
          }
        }catch(err){ alert("è§£æå¤±æ•—ï¼š"+err.message); }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  // Service Workerï¼ˆPWAï¼‰
  if("serviceWorker" in navigator){
    window.addEventListener("load", ()=>{ navigator.serviceWorker.register("service-worker.js"); });
  }

  // åˆå§‹åŒ–
  load();
  // æŠŠä¸‹æ‹‰é¸å–®é¡¯ç¤ºæˆå·²å„²å­˜åç¨±
  state.profiles.forEach((p,i)=>{
    const opt = $("#profileSelect").querySelector(`option[value="${i}"]`);
    if(opt) opt.textContent = p.name || `è¨˜æ†¶ ${i+1}`;
  });
  renderProfilesUI();
  renderList();
})();
</script>
</body>
</html>

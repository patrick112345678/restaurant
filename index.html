<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>隨機餐廳拉霸</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{--bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; --accent2:#a78bfa; --danger:#ef4444; --ok:#16a34a;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Segoe UI","Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
  .wrap{width:420px; max-width:100%; margin:14px auto; padding:12px}
  .card{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.28)}
  .title{font-weight:800; font-size:18px}
  .muted{color:var(--muted); font-size:12px}
  input,select,button{background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:8px 10px; outline:none}
  input:focus,select:focus{border-color:var(--accent)} button{cursor:pointer; font-weight:700}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .primary{background:linear-gradient(90deg,var(--accent),var(--accent2)); border:none; color:#001018}
  .ghost{background:#141a26} .danger{background:#2a1111; border-color:#7f1d1d} .ok{background:#0f2016; border-color:#14532d}
  .small{font-size:12px}
  .tag{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; background:#0c1320; border:1px solid rgba(255,255,255,.1); border-radius:999px}
  .pill{font-size:11px; padding:2px 6px; border-radius:999px; background:#0a111d; border:1px solid rgba(255,255,255,.08); color:var(--muted)}
  .list{display:grid; grid-template-columns:1fr auto; gap:6px; align-items:center}
  .divider{height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent); margin:10px 0}

  /* 手機高度自適應 + 慣性滾動 + 細捲軸 */
  .listbox{
    max-height:60svh;
    overflow-y:auto;
    -webkit-overflow-scrolling: touch;
    padding-right:4px;
  }
  .listbox::-webkit-scrollbar { width:6px; }
  .listbox::-webkit-scrollbar-track { background:transparent; }
  .listbox::-webkit-scrollbar-thumb { background-color:rgba(255,255,255,0.3); border-radius:3px; }

  /* 拉霸框 */
  .slotbox{width:100%; max-width:400px; height:60px; margin:10px auto 6px; border-radius:12px; border:2px solid rgba(255,255,255,.12); background:linear-gradient(180deg,#0c1423,#0a0f1a); display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative}
  .slottext{font-size:22px; font-weight:800; white-space:nowrap; text-align:center}
  .slotmask::before, .slotmask::after{content:""; position:absolute; left:0; right:0; height:12px; pointer-events:none}
  .slotmask::before{top:0; background:linear-gradient(180deg,rgba(15,23,42,.85),transparent)}
  .slotmask::after{bottom:0; background:linear-gradient(0deg,rgba(15,23,42,.85),transparent)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">🎰 隨機餐廳拉霸</div>
      <div class="muted">支援 5 組記憶（各自清單）。匯入時可指定要套用哪一組。</div>
      <div class="divider"></div>

      <!-- 記憶組控制列 -->
      <div class="row">
        <select id="profileSelect" title="選擇記憶組">
          <option value="0">記憶 1</option>
          <option value="1">記憶 2</option>
          <option value="2">記憶 3</option>
          <option value="3">記憶 4</option>
          <option value="4">記憶 5</option>
        </select>
        <input id="profileName" placeholder="這組的名稱，例如：新店家" style="flex:1;min-width:140px">
        <button id="btnRename" class="ok small">更名</button>
        <span class="pill" id="profileHint"></span>
      </div>

      <div class="divider"></div>

      <!-- 拉霸 -->
      <div class="slotbox slotmask"><div id="slotText" class="slottext">—</div></div>
      <div class="row">
        <select id="mode"><option value="weighted">加權抽籤</option><option value="pure">純隨機</option></select>
        <input id="exclude" placeholder="排除分類：例 台式, 速食" style="flex:1;min-width:120px">
        <button id="btnSpin" class="primary">拉一下 🎲</button>
        <button id="btnAgain" class="ghost">再拉一次</button>
      </div>

      <div class="divider"></div>

      <!-- 匯入／匯出 & 新增 -->
      <div class="row">
        <button id="btnImport" class="ghost small">匯入 JSON（可指定記憶）</button>
        <button id="btnExport" class="ghost small">匯出此記憶</button>
        <button id="btnExportAll" class="ghost small">匯出全部</button>
        <button id="btnClear" class="danger small">清空此記憶</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="name" placeholder="新增：餐廳名稱" style="flex:2;min-width:160px">
        <input id="tags" placeholder="分類(逗號)" style="flex:1;min-width:120px">
        <input id="weight" type="number" min="1" max="10" value="1" style="width:90px">
        <button id="btnAdd" class="primary">＋新增</button>
      </div>

      <div class="divider"></div>

      <!-- 清單 -->
      <div class="title" style="font-size:16px">清單</div>
      <div class="muted small">（點分類可快速填入「排除分類」）</div>
      <div id="list" class="listbox" style="margin-top:6px"></div>
    </div>
  </div>

<script>
(()=> {
  const storeKey="restaurant-picker-profiles-v1";
  const $=sel=>document.querySelector(sel);

  // ===== 狀態：5 組記憶 =====
  const state={
    active:0,
    spinning:false,
    profiles:[
      {name:"記憶 1", items:[]},
      {name:"記憶 2", items:[]},
      {name:"記憶 3", items:[]},
      {name:"記憶 4", items:[]},
      {name:"記憶 5", items:[]}
    ]
  };

  const defaults=[
    {id:"a1", name:"福隆鐵路便當", tags:["便當"], weight:1, disabled:false},
    {id:"a2", name:"小叮噹Q便當", tags:["便當"], weight:1, disabled:false},
    {id:"a3", name:"鋒元燒臘", tags:["燒臘"], weight:1, disabled:false},
    {id:"a4", name:"肯德基", tags:["速食","炸雞"], weight:1, disabled:false},
  ];

  function cur(){ return state.profiles[state.active]; }

  // ===== 儲存 / 載入 =====
  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
  function load(){
    try{
      const raw=localStorage.getItem(storeKey);
      if(raw){
        const parsed=JSON.parse(raw);
        if(Array.isArray(parsed.profiles) && parsed.profiles.length===5){
          state.profiles=parsed.profiles.map((p,i)=>({
            name: p.name || `記憶 ${i+1}`,
            items: Array.isArray(p.items) ? p.items : []
          }));
          state.active = Math.min(4, Math.max(0, parsed.active||0));
        }
      }else{
        // 預設給第一組一些資料，其他空白
        state.profiles[0].items = defaults;
      }
    }catch(e){
      state.profiles[0].items = defaults;
    }
  }

  const genId=()=>Math.random().toString(36).slice(2,9);
  const uniq=arr=>[...new Set(arr.map(s=>s.trim()).filter(Boolean))];
  const escapeHtml=s=>s.replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

  function buildPool(){
    const mode=$("#mode").value, exclude=uniq($("#exclude").value.split(","));
    let list=cur().items.filter(it=>!it.disabled);
    if(exclude.length){ list=list.filter(it=>!(it.tags||[]).some(t=>exclude.includes(t))); }
    if(list.length===0) return [];
    if(mode==="pure") return list.slice();
    const pool=[]; list.forEach(it=>{ const w=Math.max(1,Math.min(50,it.weight||1)); for(let i=0;i<w;i++) pool.push(it); });
    return pool;
  }

  function renderProfilesUI(){
    $("#profileSelect").value=String(state.active);
    $("#profileName").value=state.profiles[state.active].name||`記憶 ${state.active+1}`;
    $("#profileHint").textContent = `目前：${state.profiles[state.active].name}`;
  }

  function renderList(){
    const root=$("#list"); root.innerHTML="";
    const items=cur().items;
    if(items.length===0){ root.innerHTML=`<div class="muted">這組目前沒有餐廳，請先匯入或新增。</div>`; return; }

    const head=document.createElement("div");
    head.className="list muted small";
    head.innerHTML=`<div>名稱</div><div style="text-align:right">權重 / 操作</div>`;
    root.appendChild(head);

    items.forEach(it=>{
      const row=document.createElement("div"); row.className="list";

      const left=document.createElement("div");
      const name=document.createElement("div");
      name.innerHTML=`<strong ${it.disabled?'style="opacity:.5;text-decoration:line-through"':''}>${escapeHtml(it.name)}</strong>`;
      left.appendChild(name);

      const tags=document.createElement("div");
      (it.tags||[]).forEach(t=>{
        const b=document.createElement("button");
        b.className="tag small"; b.textContent=t;
        b.onclick=()=>{const ex=uniq($("#exclude").value.split(",")); if(ex.includes(t)) $("#exclude").value=ex.filter(x=>x!==t).join(", "); else { ex.push(t); $("#exclude").value=ex.join(", "); }};
        left.appendChild(b);
      });

      const right=document.createElement("div"); right.style.textAlign="right";
      const w=document.createElement("span"); w.className="pill"; w.textContent="x"+(it.weight||1);

      const up=document.createElement("button"); up.className="ghost small"; up.textContent="＋";
      up.title="權重 +1"; up.onclick=()=>{ it.weight=Math.min(10,(it.weight||1)+1); save(); renderList(); };

      const down=document.createElement("button"); down.className="ghost small"; down.textContent="－";
      down.title="權重 -1"; down.onclick=()=>{ it.weight=Math.max(1,(it.weight||1)-1); save(); renderList(); };

      const toggle=document.createElement("button"); toggle.className="ghost small"; toggle.textContent=it.disabled?"恢復":"排除";
      toggle.onclick=()=>{ it.disabled=!it.disabled; save(); renderList(); };

      const del=document.createElement("button"); del.className="danger small"; del.textContent="刪除";
      del.onclick=()=>{ cur().items = cur().items.filter(x=>x.id!==it.id); save(); renderList(); };

      right.append(w, up, down, toggle, del);
      row.append(left, right);
      root.appendChild(row);
    });
  }

  // ===== 拉霸（只更新 slotText） =====
  let spinTimer=null;
  function spinOnce(){
    const pool=buildPool();
    const slot=document.getElementById("slotText");
    if(!pool.length){ if(slot) slot.textContent="（沒有可抽的店家）"; return; }
    if(state.spinning) return;
    state.spinning=true;

    let step=35, elapsed=0, idx=Math.floor(Math.random()*pool.length);
    const total=1800+Math.random()*900;
    if (slot) slot.textContent="開始！";
    clearInterval(spinTimer);

    try{
      spinTimer=setInterval(()=>{
        elapsed+=step;
        idx=(idx+1+Math.floor(Math.random()*2))%pool.length;
        if (slot) slot.textContent=pool[idx].name;
        step=Math.min(140, step*1.06);
        if (elapsed>=total){
          clearInterval(spinTimer);
          const pick=pool[idx];
          if (slot) slot.textContent=pick.name;
          state.spinning=false;
        }
      }, step);
    }catch(e){
      clearInterval(spinTimer);
      state.spinning=false;
      console.error(e);
    }
  }

  // ===== 匯入 / 匯出（可指定記憶組） =====
  function exportJson(obj, filename){
    const data=JSON.stringify(obj, null, 2);
    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(data).then(()=>alert(`已複製到剪貼簿：${filename}`)).catch(()=>openText(data));
    }else openText(data);
    function openText(text){
      const w=window.open("", "_blank"); if(!w){ alert("請允許開啟新視窗"); return; }
      w.document.write("<pre style='white-space:pre-wrap;padding:12px;background:#0f172a;color:#e5e7eb;'>"+text.replace(/</g,"&lt;")+"</pre>");
      w.document.close();
    }
  }

  function normalizeItems(list){
    return (list||[]).map(x=>({
      id: x.id || genId(),
      name: x.name || "",
      tags: Array.isArray(x.tags) ? x.tags : [],
      weight: x.weight || 1,
      disabled: !!x.disabled
    })).filter(x=>x.name.trim().length>0);
  }

  // ===== 綁定事件 =====
  document.getElementById("btnSpin").onclick=spinOnce;
  document.getElementById("btnAgain").onclick=spinOnce;

  // 記憶組切換 / 更名
  $("#profileSelect").onchange=(e)=>{ state.active=Number(e.target.value||0); save(); renderProfilesUI(); renderList(); };
  $("#btnRename").onclick=()=>{ const v=$("#profileName").value.trim(); if(!v) return; state.profiles[state.active].name=v; save(); renderProfilesUI(); };

  // 新增 / 清空
  document.getElementById("btnAdd").onclick=()=>{
    const name=$("#name").value.trim(); if(!name) return;
    const tags=uniq($("#tags").value.split(","));
    const weight=Math.max(1,Math.min(10,parseInt($("#weight").value)||1));
    cur().items.push({id:genId(), name, tags, weight, disabled:false});
    $("#name").value=""; $("#tags").value=""; $("#weight").value="1";
    save(); renderList();
  };

  document.getElementById("btnClear").onclick=()=>{
    if(confirm(`確定清空「${cur().name||"這組"}」的清單？`)){
      cur().items=[]; save(); renderList();
      const slot=document.getElementById("slotText"); if (slot) slot.textContent="—";
    }
  };

  // 匯出：當前記憶 / 全部
  document.getElementById("btnExport").onclick=()=>exportJson({items:cur().items}, `${state.profiles[state.active].name||"profile"}.json`);
  document.getElementById("btnExportAll").onclick=()=>exportJson({active:state.active, profiles:state.profiles}, "all-profiles.json");

  // 匯入（可指定要套到哪一組、取代或合併）
  document.getElementById("btnImport").onclick=()=>{
    const input=document.createElement("input");
    input.type="file"; input.accept="application/json";
    input.onchange=(e)=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const json=JSON.parse(reader.result);

          // 1) 決定要匯入到哪一組
          const ask = prompt(`要匯入到第幾組記憶？\n輸入 1~5；留空=目前這一組（${state.active+1}：${cur().name||("記憶 "+(state.active+1))}）`);
          let targetIdx = state.active;
          if(ask && /^[1-5]$/.test(ask)) targetIdx = Number(ask)-1;

          // 2) 判斷匯入內容格式
          if(Array.isArray(json.items)){
            // 單一清單
            const imported = normalizeItems(json.items);

            // 3) 取代 or 合併
            const replace = confirm(`要用匯入資料「取代」記憶 ${targetIdx+1}（${state.profiles[targetIdx].name}）嗎？\n按「取消」則改為「合併」。`);
            if(replace){
              state.profiles[targetIdx].items = imported;
            }else{
              // 合併（以 name 為 key 去重）
              const existing = state.profiles[targetIdx].items.slice();
              const map = new Map(existing.map(x=>[x.name, x]));
              imported.forEach(x=>{
                if(map.has(x.name)){
                  // 若已存在，更新 tags/weight（可依需求調整）
                  const o = map.get(x.name);
                  const tags = Array.from(new Set([...(o.tags||[]), ...(x.tags||[])]));
                  map.set(x.name, {...o, tags, weight: x.weight || o.weight || 1, disabled: !!x.disabled});
                }else{
                  map.set(x.name, x);
                }
              });
              state.profiles[targetIdx].items = Array.from(map.values());
            }

            save(); renderProfilesUI(); if(targetIdx===state.active) renderList();
            const slot=document.getElementById("slotText");
            if (slot) slot.textContent=`已匯入到「${state.profiles[targetIdx].name}」`;
          }
          else if (Array.isArray(json.profiles) && json.profiles.length===5){
            // 全部記憶（完整備份）格式
            const newProfiles = json.profiles.map((p,i)=>({
              name: p.name || `記憶 ${i+1}`,
              items: normalizeItems(p.items)
            }));
            const replaceAll = confirm("偵測到 5 組完整備份，要「取代」你的全部記憶嗎？（取消=只匯入到目前這一組）");
            if(replaceAll){
              state.profiles = newProfiles;
            }else{
              state.profiles[state.active].items = newProfiles[state.active].items;
            }
            save(); renderProfilesUI(); renderList();
          }
          else{
            alert("JSON 格式錯誤：需 { items:[...] } 或 { profiles:[...5組...] }");
          }
        }catch(err){ alert("解析失敗："+err.message); }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  // Service Worker（PWA）
  if("serviceWorker" in navigator){
    window.addEventListener("load", ()=>{ navigator.serviceWorker.register("service-worker.js"); });
  }

  // 初始化
  load();
  // 把下拉選單顯示成已儲存名稱
  state.profiles.forEach((p,i)=>{
    const opt = $("#profileSelect").querySelector(`option[value="${i}"]`);
    if(opt) opt.textContent = p.name || `記憶 ${i+1}`;
  });
  renderProfilesUI();
  renderList();
})();
</script>
</body>
</html>
